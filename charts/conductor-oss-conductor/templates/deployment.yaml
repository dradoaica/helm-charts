apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "conductor-oss-conductor.fullname" . }}
  labels:
    {{- include "conductor-oss-conductor.labels" . | nindent 4 }}
  {{- with (include "conductor-oss-conductor.annotations" .) }}
  annotations:
    {{- . | nindent 4 }}
  {{- end }}
spec:
  {{- with .Values.revisionHistoryLimit }}
  revisionHistoryLimit: {{ . }}
  {{- end }}
  {{- with .Values.updateStrategy.type }}
  strategy:
    type: {{ . }}
  {{- end }}
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "conductor-oss-conductor.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "conductor-oss-conductor.podLabels" . | nindent 8 }}
      {{- with (include "conductor-oss-conductor.podAnnotations" .) }}
      annotations:
        {{- . | nindent 8 }}
      {{- end }}
    spec:
      terminationGracePeriodSeconds: {{ .Values.terminationGracePeriodSeconds }}
      serviceAccountName: {{ include "conductor-oss-conductor.serviceAccountName" . }}
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.podSecurityContext.enabled }}
      securityContext:
        {{- toYaml (omit .Values.podSecurityContext "enabled") | nindent 8 }}
      {{- end }}
      {{- if .Values.priorityClassName }}
      priorityClassName: {{ .Values.priorityClassName | quote }}
      {{- end }}
      {{- if .Values.extraInitContainers }}
      initContainers:
        {{- toYaml .Values.extraInitContainers | nindent 8 }}
      {{- end }}
      containers:
        {{- if .Values.extraContainers }}
        {{- toYaml .Values.extraContainers | nindent 8 }}
        {{- end }}
        - name: conductor
          image: {{ include "conductor-oss-conductor.image" . }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          {{- if .Values.containerSecurityContext.enabled }}
          securityContext:
            {{- toYaml (omit .Values.containerSecurityContext "enabled") | nindent 12 }}
          {{- end }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          env:
            - name: JVM_OPTS
              value: >-
                -server
                -XX:+AlwaysActAsServerClassMachine
                -XX:+UseContainerSupport
                -XX:+AlwaysPreTouch
                -XX:+UseG1GC
                -XX:G1HeapRegionSize={{ default 1 .Values.memory.g1HeapRegionSizeMb }}M
                -XX:MaxGCPauseMillis=200
                -XX:+ExplicitGCInvokesConcurrent
                -XX:+UseStringDeduplication
                -XX:+ParallelRefProcEnabled
                -XX:-OmitStackTraceInFastThrow
                -XX:+ExitOnOutOfMemoryError
                -XX:+HeapDumpOnOutOfMemoryError
                -XX:HeapDumpPath=/tmp/heapdump.hprof
                -XX:MaxMetaspaceSize={{ default 256 .Values.memory.maxMetaspaceSizeMb }}M
                -XX:ReservedCodeCacheSize={{ default 240 .Values.memory.reservedCodeCacheSizeMb }}M
                -XX:MaxDirectMemorySize={{ default 256 .Values.memory.maxDirectMemorySizeMb }}M
                -Xms{{ default 2048 .Values.memory.onHeapMb }}M
                -Xmx{{ default 2048 .Values.memory.onHeapMb }}M
                {{ .Values.env.EXTRA_JVM_OPTS }}
            {{- if .Values.app.stack }}
            - name: conductor.app.stack
              value: {{ .Values.app.stack | quote }}
            {{- end }}
            {{- if .Values.app.appId }}
            - name: conductor.app.appId
              value: {{ .Values.app.appId | quote }}
            {{- end }}
            {{- if .Values.app.executorServiceMaxThreadCount }}
            - name: conductor.app.executorServiceMaxThreadCount
              value: {{ .Values.app.executorServiceMaxThreadCount | quote }}
            {{- end }}
            {{- if .Values.app.workflowOffsetTimeout }}
            - name: conductor.app.workflowOffsetTimeout
              value: {{ .Values.app.workflowOffsetTimeout | quote }}
            {{- end }}
            {{- if .Values.app.maxPostponeDurationSeconds }}
            - name: conductor.app.maxPostponeDurationSeconds
              value: {{ .Values.app.maxPostponeDurationSeconds | quote }}
            {{- end }}
            {{- if .Values.app.sweeperThreadCount }}
            - name: conductor.app.sweeperThreadCount
              value: {{ .Values.app.sweeperThreadCount | quote }}
            {{- end }}
            {{- if .Values.app.sweeperWorkflowPollTimeout }}
            - name: conductor.app.sweeperWorkflowPollTimeout
              value: {{ .Values.app.sweeperWorkflowPollTimeout | quote }}
            {{- end }}
            {{- if .Values.app.eventProcessorThreadCount }}
            - name: conductor.app.eventProcessorThreadCount
              value: {{ .Values.app.eventProcessorThreadCount | quote }}
            {{- end }}
            {{- if .Values.app.eventMessageIndexingEnabled }}
            - name: conductor.app.eventMessageIndexingEnabled
              value: {{ .Values.app.eventMessageIndexingEnabled | quote }}
            {{- end }}
            {{- if .Values.app.eventExecutionIndexingEnabled }}
            - name: conductor.app.eventExecutionIndexingEnabled
              value: {{ .Values.app.eventExecutionIndexingEnabled | quote }}
            {{- end }}
            - name: conductor.app.workflowExecutionLockEnabled
              value: {{ .Values.app.workflowExecutionLockEnabled | quote }}
            {{- if .Values.app.lockLeaseTime }}
            - name: conductor.app.lockLeaseTime
              value: {{ .Values.app.lockLeaseTime | quote }}
            {{- end }}
            - name: conductor.app.lockTimeToTry
              value: {{ .Values.app.lockTimeToTry | quote }}
            {{- if .Values.app.activeWorkerLastPollTimeout }}
            - name: conductor.app.activeWorkerLastPollTimeout
              value: {{ .Values.app.activeWorkerLastPollTimeout | quote }}
            {{- end }}
            {{- if .Values.app.taskExecutionPostponeDuration }}
            - name: conductor.app.taskExecutionPostponeDuration
              value: {{ .Values.app.taskExecutionPostponeDuration | quote }}
            {{- end }}
            {{- if .Values.app.taskIndexingEnabled }}
            - name: conductor.app.taskIndexingEnabled
              value: {{ .Values.app.taskIndexingEnabled | quote }}
            {{- end }}
            {{- if .Values.app.taskExecLogIndexingEnabled }}
            - name: conductor.app.taskExecLogIndexingEnabled
              value: {{ .Values.app.taskExecLogIndexingEnabled | quote }}
            {{- end }}
            {{- if .Values.app.asyncIndexingEnabled }}
            - name: conductor.app.asyncIndexingEnabled
              value: {{ .Values.app.asyncIndexingEnabled | quote }}
            {{- end }}
            - name: conductor.app.systemTaskWorkerThreadCount
              value: {{ .Values.app.systemTaskWorkerThreadCount | quote }}
            - name: conductor.app.systemTaskMaxPollCount
              value: {{ .Values.app.systemTaskMaxPollCount | quote }}
            {{- if .Values.app.systemTaskWorkerCallbackDuration }}
            - name: conductor.app.systemTaskWorkerCallbackDuration
              value: {{ .Values.app.systemTaskWorkerCallbackDuration | quote }}
            {{- end }}
            {{- if .Values.app.systemTaskWorkerPollInterval }}
            - name: conductor.app.systemTaskWorkerPollInterval
              value: {{ .Values.app.systemTaskWorkerPollInterval | quote }}
            {{- end }}
            {{- if .Values.app.systemTaskWorkerExecutionNamespace }}
            - name: conductor.app.systemTaskWorkerExecutionNamespace
              value: {{ .Values.app.systemTaskWorkerExecutionNamespace | quote }}
            {{- end }}
            {{- if .Values.app.isolatedSystemTaskWorkerThreadCount }}
            - name: conductor.app.isolatedSystemTaskWorkerThreadCount
              value: {{ .Values.app.isolatedSystemTaskWorkerThreadCount | quote }}
            {{- end }}
            - name: conductor.app.asyncUpdateShortRunningWorkflowDuration
              value: {{ .Values.app.asyncUpdateShortRunningWorkflowDuration | quote }}
            {{- if .Values.app.asyncUpdateDelay }}
            - name: conductor.app.asyncUpdateDelay
              value: {{ .Values.app.asyncUpdateDelay | quote }}
            {{- end }}
            {{- if .Values.app.ownerEmailMandatory }}
            - name: conductor.app.ownerEmailMandatory
              value: {{ .Values.app.ownerEmailMandatory | quote }}
            {{- end }}
            {{- if .Values.app.eventQueueSchedulerPollThreadCount }}
            - name: conductor.app.eventQueueSchedulerPollThreadCount
              value: {{ .Values.app.eventQueueSchedulerPollThreadCount | quote }}
            {{- end }}
            {{- if .Values.app.eventQueuePollInterval }}
            - name: conductor.app.eventQueuePollInterval
              value: {{ .Values.app.eventQueuePollInterval | quote }}
            {{- end }}
            {{- if .Values.app.eventQueuePollCount }}
            - name: conductor.app.eventQueuePollCount
              value: {{ .Values.app.eventQueuePollCount | quote }}
            {{- end }}
            {{- if .Values.app.eventQueueLongPollTimeout }}
            - name: conductor.app.eventQueueLongPollTimeout
              value: {{ .Values.app.eventQueueLongPollTimeout | quote }}
            {{- end }}
            - name: conductor.app.workflowInputPayloadSizeThreshold
              value: {{ .Values.app.workflowInputPayloadSizeThreshold | quote }}
            - name: conductor.app.maxWorkflowInputPayloadSizeThreshold
              value: {{ .Values.app.maxWorkflowInputPayloadSizeThreshold | quote }}
            - name: conductor.app.workflowOutputPayloadSizeThreshold
              value: {{ .Values.app.workflowOutputPayloadSizeThreshold | quote }}
            - name: conductor.app.maxWorkflowOutputPayloadSizeThreshold
              value: {{ .Values.app.maxWorkflowOutputPayloadSizeThreshold | quote }}
            - name: conductor.app.taskInputPayloadSizeThreshold
              value: {{ .Values.app.taskInputPayloadSizeThreshold | quote }}
            - name: conductor.app.maxTaskInputPayloadSizeThreshold
              value: {{ .Values.app.maxTaskInputPayloadSizeThreshold | quote }}
            - name: conductor.app.taskOutputPayloadSizeThreshold
              value: {{ .Values.app.taskOutputPayloadSizeThreshold | quote }}
            - name: conductor.app.maxTaskOutputPayloadSizeThreshold
              value: {{ .Values.app.maxTaskOutputPayloadSizeThreshold | quote }}
            - name: conductor.app.maxWorkflowVariablesPayloadSizeThreshold
              value: {{ .Values.app.maxWorkflowVariablesPayloadSizeThreshold | quote }}
            {{- if .Values.app.taskExecLogSizeLimit }}
            - name: conductor.app.taskExecLogSizeLimit
              value: {{ .Values.app.taskExecLogSizeLimit | quote }}
            {{- end }}
            - name: conductor.app.workflowRepairServiceEnabled
              value: {{ .Values.app.workflowRepairServiceEnabled | quote }}
            {{- if .Values.workflowArchival.enabled }}
            - name: conductor.workflow.workflowArchival.enabled
              value: {{ .Values.workflowArchival.enabled | quote }}
            - name: conductor.workflow.workflowArchival.type
              value: {{ .Values.workflowArchival.type | quote }}
            - name: conductor.workflow.workflowArchival.ttl
              value: {{ .Values.workflowArchival.ttl | quote }}
            - name: conductor.workflow.workflowArchival.delay
              value: {{ .Values.workflowArchival.delay | quote }}
            {{- end }}
            - name: conductor.app.enableRemoveRedisKey
              value: {{ .Values.app.enableRemoveRedisKey | quote }}
            {{- if .Values.app.ttlRedisKeyExpire }}
            - name: conductor.app.ttlRedisKeyExpire
              value: {{ .Values.app.ttlRedisKeyExpire | quote }}
            {{- end }}
            - name: conductor.app.workflow.name-validation.enabled
              value: {{ .Values.app.workflowNameValidationEnabled | quote }}
            {{- if .Values.app.summaryInputOutputJsonSerializationEnabled }}
            - name: conductor.app.summary-input-output-json-serialization.enabled
              value: {{ .Values.app.summaryInputOutputJsonSerializationEnabled | quote }}
            {{- end }}
            - name: conductor.db.type
              value: {{ .Values.db.type | quote }}
            - name: conductor.queue.type
              value: {{ .Values.queue.type | quote }}
            - name: conductor.default-event-queue.type
              value: {{ .Values.defaultEventQueue.type | quote }}
            - name: queues.dynomite.threads
              value: {{ .Values.queues.dynomiteThreads | quote }}
            - name: conductor.workflow-execution-lock.type
              value: {{ .Values.workflowExecutionLock.type | quote }}
            - name: conductor.indexing.enabled
              value: {{ .Values.indexing.enabled | quote }}
            - name: conductor.indexing.type
              value: {{ .Values.indexing.type | quote }}
            {{- if .Values.externalPayloadStorage.type }}
            - name: conductor.external-payload-storage.type
              value: {{ .Values.externalPayloadStorage.type | quote }}
            {{- end }}
            - name: conductor.api-docs.cors.allowed-origins
              value: {{ .Values.cors.allowedOrigins | quote }}
            {{- $dbRedis := hasPrefix "redis" .Values.db.type }}
            {{- $queueRedis := hasPrefix "redis" .Values.queue.type }}
            {{- $lockRedis := eq .Values.workflowExecutionLock.type "redis" }}
            {{- if or $dbRedis $queueRedis $lockRedis }}
            - name: conductor.redis.hosts
              {{- if .Values.redis.hosts }}
              value: {{ .Values.redis.hosts | quote }}
              {{- else }}
              value: "{{ .Values.redis.host }}:{{ .Values.redis.port }}"
              {{- end }}
            {{- if .Values.redis.masterName }}
            - name: conductor.redis.masterName
              value: {{ .Values.redis.masterName | quote }}
            {{- end }}
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: redis-password
            - name: conductor.redis.password
              value: "$(REDIS_PASSWORD)"
            - name: conductor.redis-lock.serverAddress
              {{- if .Values.redis.hosts }}
              value: "redis://:$(REDIS_PASSWORD)@{{ .Values.redis.hosts }}"
              {{- else }}
              value: "redis://:$(REDIS_PASSWORD)@{{ .Values.redis.host }}:{{ .Values.redis.port }}"
              {{- end }}
            - name: conductor.redis.ssl
              value: {{ .Values.redis.ssl | quote }}
            - name: conductor.redis.taskDefCacheRefreshInterval
              value: {{ .Values.redis.taskDefCacheRefreshInterval | quote }}
            - name: conductor.redis.workflowNamespacePrefix
              value: {{ .Values.redis.workflowNamespacePrefix | quote }}
            - name: conductor.redis.queueNamespacePrefix
              value: {{ .Values.redis.queueNamespacePrefix | quote }}
            - name: conductor.redis.queuesNonQuorumPort
              value: {{ .Values.redis.queuesNonQuorumPort | quote }}
            - name: conductor.redis.availabilityZone
              value: {{ .Values.redis.availabilityZone | quote }}
            {{- if .Values.redis.maxIdleConnections }}
            - name: conductor.redis.maxIdleConnections
              value: {{ .Values.redis.maxIdleConnections | quote }}
            {{- end }}
            {{- if .Values.redis.minIdleConnections }}
            - name: conductor.redis.minIdleConnections
              value: {{ .Values.redis.minIdleConnections | quote }}
            {{- end }}
            {{- if .Values.redis.minEvictableIdleTimeMillis }}
            - name: conductor.redis.minEvictableIdleTimeMillis
              value: {{ .Values.redis.minEvictableIdleTimeMillis | quote }}
            {{- end }}
            {{- if .Values.redis.timeBetweenEvictionRunsMillis }}
            - name: conductor.redis.timeBetweenEvictionRunsMillis
              value: {{ .Values.redis.timeBetweenEvictionRunsMillis | quote }}
            {{- end }}
            {{- if .Values.redis.testWhileIdle }}
            - name: conductor.redis.testWhileIdle
              value: {{ .Values.redis.testWhileIdle | quote }}
            {{- end }}
            {{- if .Values.redis.numTestsPerEvictionRun }}
            - name: conductor.redis.numTestsPerEvictionRun
              value: {{ .Values.redis.numTestsPerEvictionRun | quote }}
            {{- end }}
            - name: management.health.redis.enabled
              value: {{ .Values.management.healthRedisEnabled | quote }}
            {{- end }}
            {{- if eq .Values.db.type "mysql" }}
            - name: spring.datasource.url
              value: "jdbc:mysql://{{ .Values.mysql.host }}:{{ .Values.mysql.port }}/{{ .Values.mysql.database }}"
            - name: spring.datasource.username
              value: {{ .Values.mysql.username | quote }}
            - name: spring.datasource.password
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: mysql-password
            {{- end }}
            {{- if or (eq .Values.db.type "postgres") (eq .Values.workflowExecutionLock.type "postgres") (eq .Values.indexing.type "postgres") (and .Values.externalPayloadStorage.type (eq .Values.externalPayloadStorage.type "postgres")) }}
            - name: spring.datasource.url
              value: "jdbc:postgresql://{{ .Values.postgres.host }}:{{ .Values.postgres.port }}/{{ .Values.postgres.database }}"
            - name: spring.datasource.username
              value: {{ .Values.postgres.username | quote }}
            - name: spring.datasource.password
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: postgres-password
            {{- end }}
            {{- if eq .Values.indexing.type "elasticsearch" }}
            - name: conductor.elasticsearch.url
              value: {{ .Values.elasticsearch.url | quote }}
            - name: conductor.elasticsearch.username
              value: {{ .Values.elasticsearch.username | quote }}
            - name: conductor.elasticsearch.password
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: elasticsearch-password
            - name: conductor.elasticsearch.indexName
              value: {{ .Values.elasticsearch.indexName | quote }}
            - name: conductor.elasticsearch.indexPrefix
              value: {{ .Values.elasticsearch.indexPrefix | quote }}
            - name: conductor.elasticsearch.indexReplicasCount
              value: {{ .Values.elasticsearch.indexReplicasCount | quote }}
            - name: conductor.elasticsearch.version
              value: {{ .Values.elasticsearch.version | quote }}
            - name: conductor.elasticsearch.clusterHealthColor
              value: {{ .Values.elasticsearch.clusterHealthColor | quote }}
            - name: conductor.elasticsearch.restClientConnectionTimeout
              value: {{ .Values.elasticsearch.restClientConnectionTimeout | quote }}
            - name: conductor.elasticsearch.restClientReadTimeout
              value: {{ .Values.elasticsearch.restClientReadTimeout | quote }}
            {{- end }}
            {{- if eq .Values.indexing.type "opensearch" }}
            - name: conductor.elasticsearch.url
              value: {{ .Values.opensearch.url | quote }}
            - name: conductor.elasticsearch.username
              value: {{ .Values.opensearch.username | quote }}
            - name: conductor.elasticsearch.password
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: opensearch-password
            - name: conductor.elasticsearch.indexName
              value: {{ .Values.opensearch.indexName | quote }}
            - name: conductor.elasticsearch.indexPrefix
              value: {{ .Values.opensearch.indexPrefix | quote }}
            - name: conductor.elasticsearch.indexReplicasCount
              value: {{ .Values.opensearch.indexReplicasCount | quote }}
            - name: conductor.elasticsearch.version
              value: {{ .Values.opensearch.version | quote }}
            - name: conductor.elasticsearch.clusterHealthColor
              value: {{ .Values.opensearch.clusterHealthColor | quote }}
            - name: conductor.elasticsearch.restClientConnectionTimeout
              value: {{ .Values.opensearch.restClientConnectionTimeout | quote }}
            - name: conductor.elasticsearch.restClientReadTimeout
              value: {{ .Values.opensearch.restClientReadTimeout | quote }}
            {{- end }}
            {{- if eq .Values.indexing.type "postgres" }}
            - name: conductor.elasticsearch.version
              value: '0'
            {{- end }}
            {{- if and .Values.externalPayloadStorage.type (eq .Values.externalPayloadStorage.type "postgres") }}
            - name: conductor.external-payload-storage.postgres.conductor-url
              value: {{ .Values.postgres.externalPayloadStorage.conductorUrl | quote }}
            - name: conductor.external-payload-storage.postgres.url
              value: "jdbc:postgresql://{{ .Values.postgres.host }}:{{ .Values.postgres.port }}/{{ .Values.postgres.database }}"
            - name: conductor.external-payload-storage.postgres.username
              value: {{ .Values.postgres.username | quote }}
            - name: conductor.external-payload-storage.postgres.password
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: postgres-password
            - name: conductor.external-payload-storage.postgres.table-name
              value: {{ .Values.postgres.externalPayloadStorage.tableName | quote }}
            - name: conductor.external-payload-storage.postgres.max-data-rows
              value: {{ .Values.postgres.externalPayloadStorage.maxDataRows | quote }}
            - name: conductor.external-payload-storage.postgres.max-data-days
              value: {{ .Values.postgres.externalPayloadStorage.maxDataDays | quote }}
            - name: conductor.external-payload-storage.postgres.max-data-months
              value: {{ .Values.postgres.externalPayloadStorage.maxDataMonths | quote }}
            - name: conductor.external-payload-storage.postgres.max-data-years
              value: {{ .Values.postgres.externalPayloadStorage.maxDataYears | quote }}
            {{- end }}
            {{- if .Values.amqpEventQueues.enabled }}
            - name: conductor.event-queues.amqp.enabled
              value: {{ .Values.amqpEventQueues.enabled | quote }}
            - name: conductor.event-queues.amqp.hosts
              value: {{ .Values.amqpEventQueues.hosts | quote }}
            - name: conductor.event-queues.amqp.username
              value: {{ .Values.amqpEventQueues.username | quote }}
            - name: conductor.event-queues.amqp.password
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: amqp-password
            - name: conductor.event-queues.amqp.virtualHost
              value: {{ .Values.amqpEventQueues.virtualHost | quote }}
            - name: conductor.event-queues.amqp.port
              value: {{ .Values.amqpEventQueues.port | quote }}
            - name: conductor.event-queues.amqp.useNio
              value: {{ .Values.amqpEventQueues.useNio | quote }}
            - name: conductor.event-queues.amqp.batchSize
              value: {{ .Values.amqpEventQueues.batchSize | quote }}
            - name: conductor.event-queues.amqp.pollTimeDuration
              value: {{ .Values.amqpEventQueues.pollTimeDuration | quote }}
            - name: conductor.event-queues.amqp.queueType
              value: {{ .Values.amqpEventQueues.queueType | quote }}
            - name: conductor.event-queues.amqp.sequentialMsgProcessing
              value: {{ .Values.amqpEventQueues.sequentialMsgProcessing | quote }}
            - name: conductor.event-queues.amqp.connectionTimeoutInMilliSecs
              value: {{ .Values.amqpEventQueues.connectionTimeoutInMilliSecs | quote }}
            - name: conductor.event-queues.amqp.networkRecoveryIntervalInMilliSecs
              value: {{ .Values.amqpEventQueues.networkRecoveryIntervalInMilliSecs | quote }}
            - name: conductor.event-queues.amqp.requestHeartbeatTimeoutInSecs
              value: {{ .Values.amqpEventQueues.requestHeartbeatTimeoutInSecs | quote }}
            - name: conductor.event-queues.amqp.handshakeTimeoutInMilliSecs
              value: {{ .Values.amqpEventQueues.handshakeTimeoutInMilliSecs | quote }}
            - name: conductor.event-queues.amqp.maxChannelCount
              value: {{ .Values.amqpEventQueues.maxChannelCount | quote }}
            - name: conductor.event-queues.amqp.limit
              value: {{ .Values.amqpEventQueues.limit | quote }}
            - name: conductor.event-queues.amqp.duration
              value: {{ .Values.amqpEventQueues.duration | quote }}
            - name: conductor.event-queues.amqp.retryType
              value: {{ .Values.amqpEventQueues.retryType | quote }}
            - name: conductor.event-queues.amqp.useExchange
              value: {{ .Values.amqpEventQueues.useExchange | quote }}
            {{- if .Values.amqpEventQueues.listenerQueuePrefix }}
            - name: conductor.event-queues.amqp.listenerQueuePrefix
              value: {{ .Values.amqpEventQueues.listenerQueuePrefix | quote }}
            {{- end }}
            - name: conductor.event-queues.amqp.durable
              value: {{ .Values.amqpEventQueues.durable | quote }}
            - name: conductor.event-queues.amqp.exclusive
              value: {{ .Values.amqpEventQueues.exclusive | quote }}
            - name: conductor.event-queues.amqp.maxPriority
              value: {{ .Values.amqpEventQueues.maxPriority | quote }}
            {{- end }}
            {{- if .Values.natsEventQueues.enabled }}
            - name: conductor.event-queues.nats.enabled
              value: {{ .Values.natsEventQueues.enabled | quote }}
            - name: conductor.event-queues.nats-stream.clusterId
              value: {{ .Values.natsEventQueues.natsStream.clusterId | quote }}
            - name: conductor.event-queues.nats-stream.durableName
              value: {{ .Values.natsEventQueues.natsStream.durableName | quote }}
            - name: conductor.event-queues.nats-stream.url
              value: {{ .Values.natsEventQueues.natsStream.url | quote }}
            - name: conductor.event-queues.nats-stream.listenerQueuePrefix
              value: {{ .Values.natsEventQueues.natsStream.listenerQueuePrefix | quote }}
            {{- end }}
            {{- if .Values.kafkaEventQueues.enabled }}
            - name: conductor.event-queues.kafka.enabled
              value: {{ .Values.kafkaEventQueues.enabled | quote }}
            - name: conductor.event-queues.kafka.bootstrap-servers
              value: {{ .Values.kafkaEventQueues.bootstrapServers | quote }}
            - name: conductor.event-queues.kafka.dlq-topic
              value: {{ .Values.kafkaEventQueues.dlqTopic | quote }}
            - name: conductor.event-queues.kafka.listener-queue-prefix
              value: {{ .Values.kafkaEventQueues.listenerQueuePrefix | quote }}
            - name: conductor.event-queues.kafka.poll-time-duration
              value: {{ .Values.kafkaEventQueues.pollTimeDuration | quote }}
            {{- range $name, $value := .Values.kafkaEventQueues.consumer }}
            - name: conductor.event-queues.kafka.consumer.{{ $name }}
              value: "{{ $value }}"
            {{- end }}
            {{- range $name, $value := .Values.kafkaEventQueues.producer }}
            - name: conductor.event-queues.kafka.producer.{{ $name }}
              value: "{{ $value }}"
            {{- end }}
            {{- range $name, $value := .Values.kafkaEventQueues.admin }}
            - name: conductor.event-queues.kafka.admin.{{ $name }}
              value: "{{ $value }}"
            {{- end }}
            {{- end }}
            {{- if .Values.statusListener.workflowType }}
            - name: conductor.workflow-status-listener.type
              value: {{ .Values.statusListener.workflowType | quote }}
            {{- end }}
            {{- if .Values.statusListener.taskType }}
            - name: conductor.task-status-listener.type
              value: {{ .Values.statusListener.taskType | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.url }}
            - name: conductor.status-notifier.notification.url
              value: {{ .Values.statusNotifier.url | quote }}
            {{- if .Values.statusNotifier.endpointWorkflow }}
            - name: conductor.status-notifier.notification.endpointWorkflow
              value: {{ .Values.statusNotifier.endpointWorkflow | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.endpointTask }}
            - name: conductor.status-notifier.notification.endpointTask
              value: {{ .Values.statusNotifier.endpointTask | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.subscribedTaskStatuses }}
            - name: conductor.status-notifier.notification.subscribedTaskStatuses
              value: {{ .Values.statusNotifier.subscribedTaskStatuses | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.headerPrefer }}
            - name: conductor.status-notifier.notification.headerPrefer
              value: {{ .Values.statusNotifier.headerPrefer | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.headerPreferValue }}
            - name: conductor.status-notifier.notification.headerPreferValue
              value: {{ .Values.statusNotifier.headerPreferValue | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.requestTimeoutMsConnect }}
            - name: conductor.status-notifier.notification.requestTimeoutMsConnect
              value: {{ .Values.statusNotifier.requestTimeoutMsConnect | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.requestTimeoutMsRead }}
            - name: conductor.status-notifier.notification.requestTimeoutMsRead
              value: {{ .Values.statusNotifier.requestTimeoutMsRead | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.requestTimeoutMsConnMgr }}
            - name: conductor.status-notifier.notification.requestTimeoutMsConnMgr
              value: {{ .Values.statusNotifier.requestTimeoutMsConnMgr | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.requestRetryCount }}
            - name: conductor.status-notifier.notification.requestRetryCount
              value: {{ .Values.statusNotifier.requestRetryCount | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.requestRetryIntervalMs }}
            - name: conductor.status-notifier.notification.requestRetryIntervalMs
              value: {{ .Values.statusNotifier.requestRetryIntervalMs | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.connectionPoolMaxRequest }}
            - name: conductor.status-notifier.notification.connectionPoolMaxRequest
              value: {{ .Values.statusNotifier.connectionPoolMaxRequest | quote }}
            {{- end }}
            {{- if .Values.statusNotifier.connectionPoolMaxRequestPerRoute }}
            - name: conductor.status-notifier.notification.connectionPoolMaxRequestPerRoute
              value: {{ .Values.statusNotifier.connectionPoolMaxRequestPerRoute | quote }}
            {{- end }}
            {{- end }}
            - name: conductor.integrations.ai.enabled
              value: {{ .Values.ai.enabled | quote }}
            {{- if .Values.ai.openai.apiKey }}
            - name: conductor.ai.openai.api-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-openai-api-key
            {{- end }}
            {{- if .Values.ai.openai.organizationId }}
            - name: conductor.ai.openai.organization-id
              value: {{ .Values.ai.openai.organizationId | quote }}
            {{- end }}
            {{- if .Values.ai.anthropic.apiKey }}
            - name: conductor.ai.anthropic.api-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-anthropic-api-key
            {{- end }}
            {{- if .Values.ai.mistral.apiKey }}
            - name: conductor.ai.mistral.api-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-mistral-api-key
            {{- end }}
            {{- if .Values.ai.cohere.apiKey }}
            - name: conductor.ai.cohere.api-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-cohere-api-key
            {{- end }}
            {{- if .Values.ai.grok.apiKey }}
            - name: conductor.ai.grok.api-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-grok-api-key
            {{- end }}
            {{- if .Values.ai.perplexity.apiKey }}
            - name: conductor.ai.perplexity.api-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-perplexity-api-key
            {{- end }}
            {{- if .Values.ai.huggingface.apiKey }}
            - name: conductor.ai.huggingface.api-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-huggingface-api-key
            {{- end }}
            {{- if .Values.ai.stabilityai.apiKey }}
            - name: conductor.ai.stabilityai.api-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-stabilityai-api-key
            {{- end }}
            {{- if .Values.ai.azureopenai.apiKey }}
            - name: conductor.ai.azureopenai.api-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-azureopenai-api-key
            {{- end }}
            {{- if .Values.ai.azureopenai.baseUrl }}
            - name: conductor.ai.azureopenai.base-url
              value: {{ .Values.ai.azureopenai.baseUrl | quote }}
            {{- end }}
            {{- if .Values.ai.azureopenai.deploymentName }}
            - name: conductor.ai.azureopenai.deployment-name
              value: {{ .Values.ai.azureopenai.deploymentName | quote }}
            {{- end }}
            {{- if .Values.ai.bedrock.accessKey }}
            - name: conductor.ai.bedrock.access-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-bedrock-access-key
            {{- end }}
            {{- if .Values.ai.bedrock.secretKey }}
            - name: conductor.ai.bedrock.secret-key
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: ai-bedrock-secret-key
            {{- end }}
            {{- if .Values.ai.bedrock.region }}
            - name: conductor.ai.bedrock.region
              value: {{ .Values.ai.bedrock.region | quote }}
            {{- end }}
            {{- if .Values.ai.gemini.projectId }}
            - name: conductor.ai.gemini.project-id
              value: {{ .Values.ai.gemini.projectId | quote }}
            {{- end }}
            {{- if .Values.ai.gemini.location }}
            - name: conductor.ai.gemini.location
              value: {{ .Values.ai.gemini.location | quote }}
            {{- end }}
            {{- if .Values.ai.ollama.baseUrl }}
            - name: conductor.ai.ollama.base-url
              value: {{ .Values.ai.ollama.baseUrl | quote }}
            {{- end }}
            - name: conductor.metrics-logger.enabled
              value: {{ .Values.metrics.loggerEnabled | quote }}
            - name: conductor.metrics-logger.reportPeriodSeconds
              value: {{ .Values.metrics.loggerReportPeriodSeconds | quote }}
            - name: conductor.metrics-prometheus.enabled
              value: {{ .Values.metrics.prometheusEnabled | quote }}
            - name: management.endpoints.web.exposure.include
              value: {{ .Values.management.endpointsWebExposureInclude | quote }}
            - name: management.metrics.web.server.request.autotime.percentiles
              value: {{ .Values.management.metricsPercentiles | quote }}
            - name: management.endpoint.health.show-details
              value: {{ .Values.management.healthShowDetails | quote }}
            - name: management.atlas.metrics.export.enabled
              value: {{ .Values.management.metricsExport.atlas | quote }}
            - name: management.otlp.metrics.export.enabled
              value: {{ .Values.management.metricsExport.otlp | quote }}
            - name: management.influx.metrics.export.enabled
              value: {{ .Values.management.metricsExport.influx | quote }}
            - name: management.elastic.metrics.export.enabled
              value: {{ .Values.management.metricsExport.elastic | quote }}
            - name: management.dynatrace.metrics.export.enabled
              value: {{ .Values.management.metricsExport.dynatrace | quote }}
            - name: management.new-relic.metrics.export.enabled
              value: {{ .Values.management.metricsExport.newRelic | quote }}
            - name: management.stackdriver.metrics.export.enabled
              value: {{ .Values.management.metricsExport.stackdriver | quote }}
            {{- if .Values.management.metricsExport.stackdriverProjectId }}
            - name: management.stackdriver.metrics.export.projectId
              value: {{ .Values.management.metricsExport.stackdriverProjectId | quote }}
            {{- end }}
            - name: management.datadog.metrics.export.enabled
              value: {{ .Values.management.metricsExport.datadog | quote }}
            {{- if .Values.management.metricsExport.datadogApiKey }}
            - name: management.datadog.metrics.export.apiKey
              value: {{ .Values.management.metricsExport.datadogApiKey | quote }}
            {{- end }}
            - name: management.statsd.metrics.export.enabled
              value: {{ .Values.management.metricsExport.statsd | quote }}
            - name: management.cloudwatch.metrics.export.enabled
              value: {{ .Values.management.metricsExport.cloudwatch | quote }}
            - name: management.cloudwatch.metrics.export.namespace
              value: {{ .Values.management.metricsExport.cloudwatchNamespace | quote }}
            - name: management.azuremonitor.metrics.export.enabled
              value: {{ .Values.management.metricsExport.azureMonitor | quote }}
            {{- if .Values.management.metricsExport.azureMonitorInstrumentationKey }}
            - name: management.azuremonitor.metrics.export.instrumentationKey
              value: {{ .Values.management.metricsExport.azureMonitorInstrumentationKey | quote }}
            {{- end }}
            - name: management.jmx.metrics.export.enabled
              value: {{ .Values.management.metricsExport.jmx | quote }}
            - name: conductor.grpcServer.server.enabled
              value: {{ .Values.grpcServer.enabled | quote }}
            - name: conductor.grpcServer.server.port
              value: {{ .Values.grpcServer.port | quote }}
            {{- if .Values.security.enabled }}
            - name: conductor.security.enabled
              value: {{ .Values.security.enabled | quote }}
            - name: conductor.security.auth.oidc.enabled
              value: {{ .Values.security.auth.oidc.enabled | quote }}
            - name: conductor.security.auth.oidc.discovery-uri
              value: {{ .Values.security.auth.oidc.discoveryUri | quote }}
            - name: conductor.security.auth.oidc.client-id
              value: {{ .Values.security.auth.oidc.clientId | quote }}
            {{- if .Values.security.auth.oidc.clientSecret }}
            - name: conductor.security.auth.oidc.client-secret
              valueFrom:
                secretKeyRef:
                  name: {{ include "conductor-oss-conductor.fullname" . }}
                  key: auth-oidc-client-secret
            {{- end }}
            - name: conductor.security.auth.oidc.audience
              value: {{ .Values.security.auth.oidc.audience | quote }}
            - name: conductor.security.auth.oidc.groups-claim
              value: {{ .Values.security.auth.oidc.groupsClaim | quote }}
            - name: conductor.security.auth.basic.enabled
              value: {{ .Values.security.auth.basic.enabled | quote }}
            - name: conductor.security.auth.basic.realm
              value: {{ .Values.security.auth.basic.realm | quote }}
            - name: conductor.security.auth.basic.principal
              value: {{ .Values.security.auth.basic.principal | quote }}
            - name: conductor.security.auth.basic.role
              value: {{ .Values.security.auth.basic.role | quote }}
            {{- end }}
            - name: loadSample
              value: 'false'
            - name: SPRING_PROFILES_ACTIVE
              value: {{ .Values.spring.profilesActive | quote }}
            - name: springdoc.api-docs.path
              value: {{ .Values.spring.apiDocsPath | quote }}
            - name: logging.level.root
              value: {{ .Values.logging.level.root | quote }}
            {{- range $name, $value := .Values.env }}
            - name: "{{ $name }}"
              value: "{{ $value }}"
            {{- end }}
            {{- with .Values.extraEnvVars }}
            {{- toYaml . | nindent 12 }}
            {{- end }}
          {{- if or .Values.extraEnvFrom .Values.extraEnvVarsCM .Values.extraEnvVarsSecret }}
          envFrom:
            {{- if .Values.extraEnvFrom }}
            {{- toYaml .Values.extraEnvFrom | nindent 12 }}
            {{- end }}
            {{- if .Values.extraEnvVarsCM }}
            - configMapRef:
                name: {{ .Values.extraEnvVarsCM }}
            {{- end }}
            {{- if .Values.extraEnvVarsSecret }}
            - secretRef:
                name: {{ .Values.extraEnvVarsSecret }}
            {{- end }}
          {{- end }}
          ports:
            - name: ui
              containerPort: {{ .Values.container.ports.ui }}
              protocol: TCP
            - name: rest
              containerPort: {{ .Values.container.ports.rest }}
              protocol: TCP
            {{- if .Values.grpcServer.enabled }}
            - name: grpc
              containerPort: {{ .Values.container.ports.grpc }}
              protocol: TCP
            {{- end }}
          {{- if .Values.startupProbe.enabled }}
          startupProbe: {{- include "common.tplvalues.render" (dict "value" (omit .Values.startupProbe "enabled") "context" $) | nindent 12 }}
          {{- end }}
          {{- if .Values.livenessProbe.enabled }}
          livenessProbe: {{- include "common.tplvalues.render" (dict "value" (omit .Values.livenessProbe "enabled") "context" $) | nindent 12 }}
          {{- end }}
          {{- if .Values.readinessProbe.enabled }}
          readinessProbe: {{- include "common.tplvalues.render" (dict "value" (omit .Values.readinessProbe "enabled") "context" $) | nindent 12 }}
          {{- end }}
          {{- if .Values.lifecycleHooks }}
          lifecycle: {{- include "common.tplvalues.render" (dict "value" .Values.lifecycleHooks "context" $) | nindent 12 }}
          {{- end }}
          {{- if .Values.extraVolumeMounts }}
          volumeMounts:
            {{- toYaml .Values.extraVolumeMounts | nindent 12 }}
          {{- end }}
      {{- if .Values.extraVolumes }}
      volumes:
        {{- toYaml .Values.extraVolumes | nindent 8 }}
      {{- end }}
      restartPolicy: Always
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.topologySpreadConstraints }}
      topologySpreadConstraints:
        {{- toYaml . | nindent 8 }}
      {{- end }}
